#!/bin/bash
if [[ ( -z "$REPO_PATH" && -z "$WAR_PATH" ) || ( ! -z "$REPO_PATH" && ! -z "$WAR_PATH") ]]; then
        echo "    Usage:"
        echo "    Using git: REPO_PATH=path/of/mamute/repository $0"
        echo "    Using war: WAR_PATH=path/of/mamute/war $0"
        exit 1
fi


APPLICATION_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"/..

echo "I will update the mamute of the instance: $APPLICATION_DIR . Press enter to continue..."
read

if [ ! -d "$APPLICATION_DIR"/overrides ]; then
	mkdir "$APPLICATION_DIR/overrides"
fi

customFiles=("WEB-INF/classes/messages_pt_BR.properties"
 "WEB-INF/classes/environment.properties"
 "WEB-INF/classes/development.properties"
 "WEB-INF/classes/acceptance.properties"
 "WEB-INF/classes/production.properties"
 "WEB-INF/classes/META-INF/beans.xml"
 "css/deps/custom.css"
 "css/all-*.css"
 "js/all-*.js"
 "js/jquery/jquery-plugins-*.js"
 "WEB-INF/classes/production"
 "WEB-INF/jsp/theme/custom"
 "imgs/custom")

cd mamute

echo 'Copying custom files'
for ((i=1; i<${#customFiles[@]} ; i++))
do
	echo "Copying ${customFiles[i]}"
	cp -R --parents ${customFiles[i]} "$APPLICATION_DIR/overrides"
done

echo  'Removing old version of mamute' 

echo 'Updating mamute'

if [ ! -z "$REPO_PATH" ]; then
	echo "Using github repository  $REPO_PATH"
	
	cd "$REPO_PATH"

	git checkout master
	git pull

	mvn clean package -DskipTests

	echo 'Copying new version of mamute'

	VERSION=`scripts/get-version.sh`
	cp -R target/mamute-$VERSION/* "$APPLICATION_DIR/mamute"
fi

if [ ! -z "$WAR_PATH" ]; then
	echo "Using war $WAR_PATH"

	unzip -d "$APPLICATION_DIR/mamute" "$WAR_PATH"

fi

cd "$APPLICATION_DIR"

echo 'Copying overrides to new version of mamute'
cp -R overrides/* mamute/

echo 'Removing custom files from overrides'
for ((i=1; i<${#customFiles[@]} ; i++))
do
	echo "Removing ${customFiles[i]}"
	rm -rf overrides/${customFiles[i]} 
done
